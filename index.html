<!doctype html>
<html>
    <head>
        <title>Langton's Ants</title>
        <link rel="stylesheet" type="text/css" href="style.css" />
        <script src="eventdispatcher.js" language="JavaScript"></script>
        <script src="grid.js" language="JavaScript"></script>
        <script src="ant.js" language="JavaScript"></script>
    </head>
    <body>
        <div id="container">
            <canvas id="grid"></canvas>
            <button id="reset">Reset</button>
            <button id="run_ctl">Play</button>
            <button id="slower">Slower</button>
            <button id="faster">Faster</button>
            <div style="float: left">
                <label for="iteration">Iteration:</label>
                <input id="iteration" type="text" size="6" />
            </div>
            <table id="rules">
                <caption>Ant Rules</caption>
                <thead>
                    <tr>
                        <th>On color</th>
                        <th>turn.</th>
                        <th>&nbsp;</th>
                    </tr>
                </thead>
                <tfoot>
                    <tr>
                        <td colspan="2">&nbsp;</td>
                        <td>
                            <button class="rule_add">+</button>
                        </td>
                    </tr>
                </tfoot>
                <tbody>
                    <tr>
                        <td class="swatch">&nbsp;</td>
                        <td>
                            <select>
                                <option>Left</option>
                                <option>Right</option>
                            </select>
                        </td>
                        <td>
                            <button class="rule_del">-</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <script language="JavaScript">
            (function () {
                function generateColors(ncolors) {
                    var colors = [];
                    for (var i=0; i<ncolors; i++)
                        colors.push("hsl("
                            +Math.floor(360*i/ncolors).toString()
                            +", 75%, 40%)")
                    return colors;
                }

                var grid = document.getElementById('grid');
                grid = new Ants.Grid(
                    grid, // canvas
                    10,   // rows
                    10,   // cols
                    generateColors(2)
                );

                var ant = new Ants.Ant(
                    Math.floor(grid.rows/2), // row
                    Math.floor(grid.cols/2), // col
                    0,                       // heading (radians)
                    "#fff",                  // color
                    "RL"                     // turns
                );
                grid.addAnt(ant);

                var stepHandle = null;

                function pausedHandler(f) {
                    function wrapped() {
                        var running = stepHandle != null;
                        if (running)
                            pause();
                        f.apply(this, arguments);
                        if (running)
                            play();
                    }
                    return wrapped.bind(this);
                }

                var reset = document.getElementById('reset');
                function doReset() {
                    grid.reset();
                    iteration.value = grid.iteration.toString();
                }
                reset.addEventListener('click', pausedHandler(doReset));

                var delay = 64, steps = 1;

                var faster = document.getElementById('faster');
                var slower = document.getElementById('slower');

                slower.addEventListener('click', pausedHandler(function() {
                    if (steps > 1)
                        steps /= 2
                    else
                        delay *= 2;
                }));

                faster.addEventListener('click', pausedHandler(function() {
                    if (delay > 1)
                        delay /= 2;
                    else
                        steps *= 2;
                }));

                var iteration = document.getElementById('iteration');
                iteration.value = grid.iteration.toString();
                iteration.addEventListener('change', function() {
                    var i = parseInt(iteration.value);
                    if (isNaN(i) || i < grid.iteration)
                        iteration.value = grid.iteration.toString();
                    else
                        grid.setIteration(i);
                });

                function step() {
                    grid.step(steps);
                    iteration.value = grid.iteration.toString();
                }

                function play() {
                    stepHandle = setInterval(step, delay);
                    iteration.readOnly = true;
                    runctl.innerText = 'Pause';
                }

                function pause() {
                    if (stepHandle != null) {
                        clearInterval(stepHandle);
                        stepHandle = null;
                        iteration.readOnly = false;
                        runctl.innerText = 'Play';
                    }
                }

                window.addEventListener('error', function() {
                    pause();
                });

                var runctl = document.getElementById('run_ctl');
                runctl.addEventListener('click', function() {
                    if (stepHandle == null)
                        play();
                    else
                        pause();
                });

                // TODO support multiple ants
                var ant = grid.ants[0];
                var rules = document.getElementById('rules');
                var rulebody = rules.tBodies[0];
                var rulerow = rulebody.rows[0];
                rulebody.removeChild(rulerow);

                function updateRules() {
                    pause();
                    var turns = [];
                    for (var i=0; i<rulebody.rows.length; i++) {
                        var row = rulebody.rows[i];
                        var select = row.getElementsByTagName("select")[0];
                        turns.push(Ants.Ant.Name2Turn(select.value));
                    }
                    ant.turns = turns;
                    doReset();
                }

                function delRuleClicked(e) {
                    if (grid.colors.length <= 2)
                        return;
                    var row = e.target;
                    while (row.tagName.toLowerCase() != "tr")
                        row = row.parentNode;
                    var rows = row.parentNode.rows;
                    for (var i=0; i<rows.length; i++)
                        if (rows[i] === row)
                            break;
                    if (i >= rows.length)
                        return;
                    pause();
                    grid.colors = generateColors(grid.colors.length-1);
                    grid.ants.forEach(function(ant) {
                        ant.turns.splice(i, 1);
                    });
                    doReset();
                    initRules();
                }

                function addRuleRow(color, rule) {
                    var row = rulerow.cloneNode(true);
                    rulebody.appendChild(row);
                    row.getElementsByClassName("swatch")[0].style.backgroundColor = color;
                    var select = row.getElementsByTagName('select')[0];
                    select.value = rule;
                    select.addEventListener('change', updateRules);
                    var rule_del = row.getElementsByClassName("rule_del")[0];
                    rule_del.addEventListener("click", delRuleClicked);
                }

                function initRules() {
                    while (rulebody.childNodes.length)
                        rulebody.removeChild(rulebody.firstChild);
                    for (var i=0; i<ant.turns.length; i++)
                        addRuleRow(grid.colors[i],
                            Ants.Ant.Turn2Name(ant.turns[i]));
                    var disabled = grid.colors.length <= 2;
                    var buttons = rules.getElementsByClassName("rule_del");
                    for (var i=0; i<buttons.length; i++)
                        buttons[i].disabled = disabled;
                }
                initRules();

                rules.getElementsByClassName("rule_add")[0].addEventListener("click", function() {
                    pause();
                    var ncolors = grid.colors.length+1;
                    grid.colors = generateColors(ncolors);
                    grid.ants.forEach(function(ant) {
                        while (ant.turns.length < ncolors)
                            ant.turns.push(Ants.Ant.TurnLeft);
                    });
                    doReset();
                    initRules();
                });
            })();
        </script>
    </body>
</html>
